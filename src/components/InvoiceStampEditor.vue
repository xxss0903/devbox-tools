<template>
  <div class="container">
    <div class="editor-controls" ref="editorControls">
      <!-- 顶部固定按钮 -->
      <div
        class="button-group"
        style="position: sticky; top: 0; z-index: 1000; background-color: white; padding: 10px"
      >
        <button @click="updateStamp()">刷新印章</button>
        <button @click="saveStampAsPNG">保存印章</button>
      </div>

      <!-- 印章基本设置 -->
      <div class="control-group" id="stamp-settings">
        <h3>印章基本设置</h3>
        <label
          >印章宽度 (mm):
          <input type="number" v-model.number="drawStampWidth" min="1" max="50" step="1"
        /></label>
        <label
          >印章高度 (mm):
          <input type="number" v-model.number="drawStampHeight" min="1" max="50" step="1"
        /></label>
        <label
          >圆形边框宽度 (mm): <input type="number" step="0.1" v-model.number="circleBorderWidth"
        /></label>
        <label>圆形边框颜色: <input type="color" v-model="circleBorderColor" /></label>
      </div>

      <!-- 公司名称设置 -->
      <div class="control-group" id="company-name-settings">
        <h3>公司名称设置</h3>
        <label>公司名称: <input v-model="companyName" /></label>
        <label
          >字体大小 (mm): <input type="number" v-model.number="companyFontSizeMM" step="0.1"
        /></label>
        <label>
          <span>压缩比例：{{ companyNameCompression.toFixed(2) }}</span>
          <input
            type="range"
            v-model.number="companyNameCompression"
            min="0.5"
            max="1.5"
            step="0.05"
          />
        </label>
        <label>
          <span>分布因子：{{ textDistributionFactor.toFixed(1) }}</span>
          <input
            type="range"
            v-model.number="textDistributionFactor"
            min="1"
            max="100"
            step="0.5"
          />
        </label>
        <label>
          <span>边距 (mm): </span>
          <input type="number" v-model.number="textMarginMM" min="-10" max="10" step="0.05" />
        </label>
      </div>

      <!-- 底部文字设置 -->
      <div class="control-group" id="bottom-text-settings">
        <h3>底部文字设置</h3>
        <label>底部文字: <input type="text" v-model="bottomText" /></label>
        <label
          >字体大小 (mm):
          <input type="number" v-model.number="bottomTextFontSizeMM" min="1" max="10" step="0.1"
        /></label>
        <label>
          <span>压缩比例：{{ bottomTextCompression.toFixed(2) }}</span>
          <input
            type="range"
            v-model.number="bottomTextCompression"
            min="0.5"
            max="1.5"
            step="0.05"
          />
        </label>
        <label>
          <span>字符间距 (mm)：{{ bottomTextLetterSpacing.toFixed(2) }}</span>
          <input
            type="range"
            v-model.number="bottomTextLetterSpacing"
            min="-1"
            max="10"
            step="0.05"
          />
        </label>
        <label>
          垂直位置调整 (mm):
          <input type="number" v-model.number="bottomTextPositionY" min="-10" max="10" step="0.1" />
        </label>
      </div>

      <!-- 印章编码设置 -->
      <div class="control-group" id="code-settings">
        <h3>印章编码设置</h3>
        <label>印章编码: <input v-model="code" /></label>
        <label
          >字体大小 (mm): <input type="number" v-model.number="codeFontSizeMM" step="0.1"
        /></label>
        <label>
          <span>压缩比例：{{ codeCompression.toFixed(2) }}</span>
          <input type="range" v-model.number="codeCompression" min="0.5" max="1.5" step="0.05" />
        </label>
        <label>
          <span>分布因子: {{ codeDistributionFactor.toFixed(1) }}</span>
          <input
            type="range"
            v-model.number="codeDistributionFactor"
            min="10"
            max="40"
            step="0.5"
          />
        </label>
        <label>
          边距 (mm):
          <input type="number" v-model.number="codeMarginMM" min="-10" max="10" step="0.05" />
        </label>
      </div>

      <!-- 税号设置 -->
      <div class="control-group" id="tax-number-settings">
        <h3>税号设置</h3>
        <label>税号: <input v-model="taxNumber" /></label>
        <label>
          <span>压缩比例：{{ taxNumberCompression.toFixed(2) }}</span>
          <input
            type="range"
            v-model.number="taxNumberCompression"
            min="0.5"
            max="1.5"
            step="0.05"
          />
        </label>
        <label>
          <span>字符间距 (mm)：{{ taxNumberLetterSpacing.toFixed(2) }}</span>
          <input
            type="range"
            v-model.number="taxNumberLetterSpacing"
            min="-1"
            max="20"
            step="0.05"
          />
        </label>
        <label>
          <span>垂直位置调整 (mm)：{{ taxNumberPositionY.toFixed(1) }}</span>
          <input type="range" v-model.number="taxNumberPositionY" min="-10" max="10" step="0.1" />
        </label>
      </div>

      <!-- 五角星设置 -->
      <div class="control-group" id="star-settings">
        <h3>五角星设置</h3>
        <label class="checkbox-label">
          <input type="checkbox" v-model="shouldDrawStar" />
          绘制五角星
        </label>
        <label v-if="shouldDrawStar">
          五角星直径 (mm):
          <input type="number" v-model.number="starDiameter" step="0.1" />
        </label>
        <label v-if="shouldDrawStar">
          五角星垂直位置 (mm):
          <input type="number" v-model.number="starPositionY" min="-10" max="10" step="0.1" />
        </label>
      </div>

      <!-- 防伪纹路设置 -->
      <div class="control-group">
        <h3>防伪纹路设置</h3>
        <label>
          启用防伪纹路:
          <input type="checkbox" v-model="securityPatternEnabled" />
        </label>
        <button @click="drawStamp(true, false)">刷新纹路</button>
        <label
          >纹路数量:
          <input type="range" v-model.number="securityPatternCount" min="1" max="20" step="1"
        /></label>
        <label
          >纹路长度 (mm):
          <input type="range" v-model.number="securityPatternLength" min="0.1" max="20" step="0.1"
        /></label>
        <label
          >纹路宽度 (mm):
          <input
            type="range"
            v-model.number="securityPatternWidth"
            min="0.05"
            max="0.5"
            step="0.05"
        /></label>
      </div>
    </div>

    <!-- Canvas 容器 -->
    <div class="canvas-container">
      <div style="display: flex; flex-direction: row; margin-top: 12px">
        <!-- 做旧效果设置 -->
        <div class="control-group">
          <h3>做旧效果</h3>
          <label class="checkbox-label">
            <input type="checkbox" v-model="applyAging" />
            启用做旧效果
          </label>
          <label v-if="applyAging">
            做旧强度:
            <input type="range" v-model.number="agingIntensity" min="0" max="100" step="1" />
          </label>
          <button @click="drawStamp(false, true)">刷新做旧</button>
        </div>

        <!-- 标尺设置 -->
        <div class="control-group" style="margin-left: 12px">
          <h3>标尺设置</h3>
          <label class="checkbox-label">
            <input type="checkbox" v-model="showFullRuler" />
            显示完整标尺
          </label>
        </div>
      </div>

      <canvas ref="stampCanvas" width="600" height="600"></canvas>
    </div>
  </div>
</template>
<script setup lang="ts">
import { ref, onMounted, watch, computed } from 'vue'
import { DrawStampUtils } from './stamps/DrawStampUtils'
const editorControls = ref<HTMLDivElement | null>(null)
const stampCanvas = ref<HTMLCanvasElement | null>(null)
const MM_PER_PIXEL = 10 // 毫米换算像素

// 添加响应式数据
const companyName = ref('绘制印章有限责任公司')
// 印章编码
const code = ref('1234567890123')
// 税号
const taxNumber = ref('000000000000000000')
// 公司名称字体大小（毫米）
const companyFontSizeMM = ref(4.2)
// 编码字体大小（毫米）
const codeFontSizeMM = ref(2.2)
// 编码字体宽度（毫米）
const codeFontWidthMM = ref(1.7)
// 圆形印章半径（毫米）
const circleRadius = ref(20)
// 圆形边框宽度（毫米）
const circleBorderWidth = ref(1)
// 圆形边框颜色
const circleBorderColor = ref('#ff0000')
// 五角星直径（毫米）
const starDiameter = ref(14)
// 做旧效果
const applyAging = ref(false)
// 添加新的响应式数据
const agingIntensity = ref(50)
// 文字分布因子，控制公司名称文字在椭圆上的分布范围
const textDistributionFactor = ref(20)
// 文字边距，控制公司名称文字距离椭圆边缘的距离（单位：毫米）
const textMarginMM = ref(1) // 默认值为1mm
// 编码边距，控制印章编码距离椭圆边缘的距离（单位：毫米）
const codeMarginMM = ref(1) // 默认值为1mm
// 编码分布因子，控制印章编码在椭圆下方的分布范围
const codeDistributionFactor = ref(20) // 默认值可以根据需要调整
// 印章底部文字
const bottomText = ref('合同专用章')
// 底部文字大小，默认 4mm
const bottomTextFontSizeMM = ref(4.6)
const bottomTextFontWidthMM = ref(3)
// 底部文字字符间距，默认 0
const bottomTextLetterSpacing = ref(0)
// 五角星垂直位置调整，默认 0
const starPositionY = ref(0)
// 底部文字垂直位置调整，默认 0
const bottomTextPositionY = ref(-5)
const companyNameCompression = ref(1)
const bottomTextCompression = ref(1)
const codeCompression = ref(1)
// 防伪纹路
const securityPatternEnabled = ref(true)
const securityPatternDensity = ref(0.5)
const securityPatternWidth = ref(0.2) // 纹路宽度，单位为毫米
const securityPatternColor = ref('#FF0000')
const securityPatternCount = ref(5) // 防伪纹路数量
const securityPatternLength = ref(2) // 纹路长度，单位为毫米

const stampOffsetX = ref(0) // 水平偏移量（单位：毫米）
const stampOffsetY = ref(0) // 垂直偏移量（单位：毫米）
const showFullRuler = ref(false)
const shouldDrawStar = ref(false) // 默认绘制五角星
const taxNumberCompression = ref(1) // 税号文字宽度缩放比例
const taxNumberLetterSpacing = ref(0.3) // 税号文字间距（单位：毫米）
const taxNumberPositionY = ref(0) // 税号垂直位置调整，默认为0

// 新增一个响应式变量来存储做旧效果的参数
const agingEffectParams = ref<
  Array<{
    x: number
    y: number
    noiseSize: number
    noise: number
    strongNoiseSize: number
    strongNoise: number
    fade: number
    seed: number // 保存随机数字
  }>
>([])

const addAgingEffect = (
  ctx: CanvasRenderingContext2D,
  width: number,
  height: number,
  forceRefresh: boolean = false
) => {
  const imageData = ctx.getImageData(0, 0, width, height)
  const data = imageData.data

  const centerX = width / 2
  const centerY = height / 2
  const radius = (circleRadius.value + 1) * MM_PER_PIXEL

  // 如果需要刷新或者参数数组为空,则重新生成参数
  if (forceRefresh || agingEffectParams.value.length === 0) {
    agingEffectParams.value = []
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const index = (y * width + x) * 4
        const distanceFromCenter = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2))
        if (
          distanceFromCenter <= radius &&
          data[index] > 200 &&
          data[index + 1] < 50 &&
          data[index + 2] < 50
        ) {
          const intensityFactor = agingIntensity.value / 100
          let seed = Math.random()
          agingEffectParams.value.push({
            x,

            y,
            noiseSize: Math.random() * 3 + 1,
            noise: Math.random() * 200 * intensityFactor,
            strongNoiseSize: Math.random() * 5 + 2,
            strongNoise: Math.random() * 250 * intensityFactor + 5,
            fade: Math.random() * 50 * intensityFactor,
            seed: seed
          })
        }
      }
    }
  }

  // 使用保存的参数应用做旧效果
  agingEffectParams.value.forEach((param) => {
    const { x, y, noiseSize, noise, strongNoiseSize, strongNoise, fade, seed } = param
    const index = (y * width + x) * 4

    if (seed < 0.4) {
      addCircularNoise(data, width, x, y, noiseSize, noise)
    }

    if (seed < 0.05) {
      addCircularNoise(data, width, x, y, strongNoiseSize, strongNoise)
    }

    if (seed < 0.2) {
      data[index] = Math.min(255, data[index] + fade)
      data[index + 1] = Math.min(255, data[index + 1] + fade)
      data[index + 2] = Math.min(255, data[index + 2] + fade)
    }
  })

  ctx.putImageData(imageData, 0, 0)
}

// 辅助函数,用于添加圆形噪点
const addCircularNoise = (
  data: Uint8ClampedArray,
  width: number,
  x: number,
  y: number,
  size: number,
  intensity: number
) => {
  const radiusSquared = (size * size) / 4
  for (let dy = -size / 2; dy < size / 2; dy++) {
    for (let dx = -size / 2; dx < size / 2; dx++) {
      if (dx * dx + dy * dy <= radiusSquared) {
        const nx = Math.round(x + dx)
        const ny = Math.round(y + dy)
        const nIndex = (ny * width + nx) * 4
        if (nIndex >= 0 && nIndex < data.length) {
          data[nIndex] = Math.min(255, data[nIndex] + intensity)
          data[nIndex + 1] = Math.min(255, data[nIndex + 1] + intensity)
          data[nIndex + 2] = Math.min(255, data[nIndex + 2] + intensity)
        }
      }
    }
  }
}

const saveStampAsPNG = () => {
  drawStampUtils.saveStampAsPNG()
}

const drawStampWidth = ref(40)
const drawStampHeight = ref(30)

const updateStamp = () => {
  drawStamp()
}

// 绘制工具
let drawStampUtils: DrawStampUtils
// 初始化绘制印章参数
const initDrawStampUtils = () => {
  drawStampUtils = new DrawStampUtils(stampCanvas.value, MM_PER_PIXEL)
}

const drawStamp = () => {
  // 使用drawstamputils进行绘制
  drawStampUtils.refreshStamp()
}

onMounted(() => {
  initDrawStampUtils()
  drawStamp()
})

// 监听所有响应式数据的变化
watch(
  [
    companyName,
    code,
    companyFontSizeMM,
    codeFontSizeMM,
    circleRadius,
    circleBorderWidth,
    circleBorderColor,
    starDiameter,
    codeDistributionFactor,
    textDistributionFactor,
    textMarginMM,
    codeMarginMM,
    agingIntensity,
    bottomText,
    bottomTextFontSizeMM,
    bottomTextLetterSpacing,
    bottomTextPositionY,
    taxNumber,
    applyAging,
    agingIntensity,
    companyNameCompression,
    bottomTextCompression,
    codeCompression,
    bottomTextLetterSpacing,
    securityPatternDensity,
    securityPatternColor,
    securityPatternDensity,
    securityPatternColor,
    securityPatternEnabled,
    securityPatternCount,
    securityPatternLength,
    securityPatternWidth,
    drawStampWidth,
    drawStampHeight,
    shouldDrawStar,
    starPositionY,
    taxNumberCompression,
    taxNumberLetterSpacing,
    taxNumberPositionY,
    starDiameter
  ],
  () => {
    drawStamp()
  }
)
</script>
<style scoped>
.container {
  display: flex;
  height: 50%; /* 使用视口高度 */
  overflow: hidden;
}

.editor-controls {
  width: 300px;
  padding: 10px;
  background-color: #f0f0f0;
  overflow-y: auto; /* 允许垂直滚动 */
  max-height: 70vh; /* 最大高度为视口高度 */
  box-sizing: border-box; /* 确保padding不会增加总宽度 */
}

.control-group {
  margin-bottom: 15px;
  padding: 10px;
  background-color: white;
  border-radius: 5px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
}

.control-group h3 {
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 16px;
  color: #333;
}

.editor-controls label {
  display: flex;
  flex-direction: column;
  margin-bottom: 8px;
  font-size: 14px;
}

.editor-controls input[type='text'],
.editor-controls input[type='number'],
.editor-controls input[type='range'] {
  width: 100%;
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 3px;
  box-sizing: border-box; /* 确保padding不会增加总宽度 */
}

.editor-controls input[type='color'] {
  width: 100%;
  height: 30px;
  padding: 0;
  border: none;
}

.checkbox-label {
  flex-direction: row !important;
  align-items: center;
}

.checkbox-label input {
  margin-right: 5px;
}

.button-group {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
}

button {
  padding: 8px 16px;
  background-color: #4caf50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

button:hover {
  background-color: #45a049;
}

.canvas-container {
  flex-grow: 1;
  flex-direction: column;
  background-color: aliceblue;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: auto; /* 允许内容溢出时滚动 */
}

canvas {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}
</style>
